datatype Byte<1>
	@type_checker "Byte"
	@java_type "byte"
datatype Integer<2>
	@type_checker "Integer"
	@java_type "short"
datatype Long<4>
	@type_checker "Integer"
	@java_type "int"
datatype LongLong<8>
	@type_checker "Integer"
	@java_type "long"
thing fragment Msgs {
	message m2(a : Byte @upsize "not", c : LongLong, b : Byte @upsize "not")
	@code "0x00"
	message m1(a : Byte @upsize "not", e : LongLong, d : Long @weakparam "true", c : Integer, b : Byte @upsize "not")
	@code "0x01"
	message m3(a : Long)
	@code "0x02"
	message m2ac(a : Byte @upsize "not", c : LongLong)
	@code "0x03"
	message m2b(b : Byte @upsize "not")
	@code "0x04"
	message m1ae(a : Byte @upsize "not", e : LongLong)
	@code "0x05"
	message m1dcb(d : Long @weakparam "true", c : Integer, b : Byte @upsize "not")
	@code "0x06"
	message m3_()
	@code "0x07"
	message m3a(a : Long)
	@code "0x08"
	function rnd() : Byte do
		return `Math.floor(Math.random() * Math.floor(256))`
	end
}
thing App includes Msgs {
	provided port app {
		sends m3_ sends m3a receives m2ac receives m2b receives m1ae receives m1dcb
	}
	internal port diversified {
		sends m2 sends m1ae sends m1dcb sends m1 receives m2 receives m1ae receives m1dcb receives m1
	}
	property id : Byte
	statechart init WaitForM1 {
		on entry `
			var fs = require('fs');
			process.writeable = fs.createWriteStream('out.log');
			process.stdout.write = process.stderr.write = process.writeable.write.bind(process.writeable);
		`
		state WaitForM1 {
			transition -> WaitForM2
			event e : diversified?m1
			action do
				id = e.a
				println "#APP: Ooh, I needed that app?m1(" , e.a , ", " , e.b , ", " , e.c , ", " , e.d , ", " , e.e , ")!"
			end
		}
		state WaitForM2 {
			transition -> SendAck
			event e : diversified?m2
			action println "#APP: Ooh, I needed that app?m2(" , e.a , ", " , e.b , ", " , e.c , ")!"
		}
		state SendAck {
			on entry do
				println "#APP: Come get some app!m3(" , id , ")!"
				do
					do
						println "!" , "7" , ','
						println ":" , "Byte" , ','
						println "?" , "0" , ','
						app!m3_()
					end
					do
						var m3aArg0 : Long = id
						println "!" , "8" , ',' , `((` & m3aArg0 & ` >> 24) & 0xFF)` , ',' , `((` & m3aArg0 & ` >> 16) & 0xFF)` , ',' , `((` & m3aArg0 & ` >> 8) & 0xFF)` , ',' , `((` & m3aArg0 & ` >> 0) & 0xFF)` , ','
						println ":" , "Byte" , ',' , "Long" , ',' , "Long" , ',' , "Long" , ',' , "Long" , ','
						println "?" , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ','
						app!m3a(m3aArg0)
					end
				end
			end
			transition -> WaitForM1
		}
		region generate_m2_from_m2ac_and_m2b init INIT {
			composite state INIT init S1 {
				property a : Byte
				property c : LongLong
				property b : Byte
				state S1 @diversify "not" {
					transition -> S2
					event ev : app?m2ac
					action do
						a = ev.a
						c = ev.c
					end
					transition -> S3
					event ev : app?m2b
					action do
						b = ev.b
					end
				}
				state S2 @diversify "not" {
					transition -> S4
					event ev : app?m2b
					action do
						b = ev.b
					end
				}
				state S3 @diversify "not" {
					transition -> S4
					event ev : app?m2ac
					action do
						a = ev.a
						c = ev.c
					end
				}
				state S4 @diversify "not" {
					on entry do
						diversified!m2(a, c, b)
					end
					transition -> S1
				}
			}
		}
		region generate_m1_from_m1ae_and_m1dcb init INIT {
			composite state INIT init S1 {
				property a : Byte
				property e : LongLong
				property d : Long
				property c : Integer
				property b : Byte
				state S1 @diversify "not" {
					transition -> S2
					event ev : app?m1ae
					action do
						a = ev.a
						e = ev.e
					end
					transition -> S3
					event ev : app?m1dcb
					action do
						d = ev.d
						c = ev.c
						b = ev.b
					end
				}
				state S2 @diversify "not" {
					transition -> S4
					event ev : app?m1dcb
					action do
						d = ev.d
						c = ev.c
						b = ev.b
					end
				}
				state S3 @diversify "not" {
					transition -> S4
					event ev : app?m1ae
					action do
						a = ev.a
						e = ev.e
					end
				}
				state S4 @diversify "not" {
					on entry do
						diversified!m1(a, e, d, c, b)
					end
					transition -> S1
				}
			}
		}
	}
}
thing Client includes Msgs {
	required port app {
		sends m2ac sends m2b sends m1ae sends m1dcb receives m3_ receives m3a
	}
	internal port diversified {
		sends m3 receives m3
	}
	property counter : Integer = 0
	property start : Integer
	property _a : Byte
	property _b : Byte
	property _c : Byte
	property _d : Byte
	property _e : Byte
	statechart init RUN {
		on entry do
			_a = rnd()
			_b = 0x02
			start = `new Date()`
		end
		state RUN {
			on entry do
				_c = rnd()% 20
				_d = rnd()% 10 + 20
				_e = rnd()% 5 + 10
				println "#CLI: Come get some app!m1(" , _a , ", " , _b , ", " , _c , ", " , _d , ", " , _e , ")!"
				do
					do
						var m1aeArg0 : Byte = _a
						var m1aeArg1 : LongLong = _e
						println "!" , "5" , ',' , `((` & m1aeArg0 & ` >> 0) & 0xFF)` , ',' , `((` & m1aeArg1 & ` >> 56) & 0xFF)` , ',' , `((` & m1aeArg1 & ` >> 48) & 0xFF)` , ',' , `((` & m1aeArg1 & ` >> 40) & 0xFF)` , ',' , `((` & m1aeArg1 & ` >> 32) & 0xFF)` , ',' , `((` & m1aeArg1 & ` >> 24) & 0xFF)` , ',' , `((` & m1aeArg1 & ` >> 16) & 0xFF)` , ',' , `((` & m1aeArg1 & ` >> 8) & 0xFF)` , ',' , `((` & m1aeArg1 & ` >> 0) & 0xFF)` , ','
						println ":" , "Byte" , ',' , "Byte" , ',' , "LongLong" , ',' , "LongLong" , ',' , "LongLong" , ',' , "LongLong" , ',' , "LongLong" , ',' , "LongLong" , ',' , "LongLong" , ',' , "LongLong" , ','
						println "?" , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ','
						app!m1ae(m1aeArg0, m1aeArg1)
					end
					do
						var m1dcbArg0 : Long = _d
						var m1dcbArg1 : Integer = _c
						var m1dcbArg2 : Byte = _b
						println "!" , "6" , ',' , `((` & m1dcbArg0 & ` >> 24) & 0xFF)` , ',' , `((` & m1dcbArg0 & ` >> 16) & 0xFF)` , ',' , `((` & m1dcbArg0 & ` >> 8) & 0xFF)` , ',' , `((` & m1dcbArg0 & ` >> 0) & 0xFF)` , ',' , `((` & m1dcbArg1 & ` >> 8) & 0xFF)` , ',' , `((` & m1dcbArg1 & ` >> 0) & 0xFF)` , ',' , `((` & m1dcbArg2 & ` >> 0) & 0xFF)` , ','
						println ":" , "Byte" , ',' , "Long" , ',' , "Long" , ',' , "Long" , ',' , "Long" , ',' , "Integer" , ',' , "Integer" , ',' , "Byte" , ','
						println "?" , "0" , ',' , "1" , ',' , "1" , ',' , "1" , ',' , "1" , ',' , "0" , ',' , "0" , ',' , "0" , ','
						app!m1dcb(m1dcbArg0, m1dcbArg1, m1dcbArg2)
					end
				end
				println "#CLI: Come get some app!m2(" , _a , ", " , _b , ", " , _c , ")!"
				do
					do
						var m2acArg0 : Byte = _a
						var m2acArg1 : LongLong = _c
						println "!" , "3" , ',' , `((` & m2acArg0 & ` >> 0) & 0xFF)` , ',' , `((` & m2acArg1 & ` >> 56) & 0xFF)` , ',' , `((` & m2acArg1 & ` >> 48) & 0xFF)` , ',' , `((` & m2acArg1 & ` >> 40) & 0xFF)` , ',' , `((` & m2acArg1 & ` >> 32) & 0xFF)` , ',' , `((` & m2acArg1 & ` >> 24) & 0xFF)` , ',' , `((` & m2acArg1 & ` >> 16) & 0xFF)` , ',' , `((` & m2acArg1 & ` >> 8) & 0xFF)` , ',' , `((` & m2acArg1 & ` >> 0) & 0xFF)` , ','
						println ":" , "Byte" , ',' , "Byte" , ',' , "LongLong" , ',' , "LongLong" , ',' , "LongLong" , ',' , "LongLong" , ',' , "LongLong" , ',' , "LongLong" , ',' , "LongLong" , ',' , "LongLong" , ','
						println "?" , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ',' , "0" , ','
						app!m2ac(m2acArg0, m2acArg1)
					end
					do
						var m2bArg0 : Byte = _b
						println "!" , "4" , ',' , `((` & m2bArg0 & ` >> 0) & 0xFF)` , ','
						println ":" , "Byte" , ',' , "Byte" , ','
						println "?" , "0" , ',' , "0" , ','
						app!m2b(m2bArg0)
					end
				end
				counter ++
			end
			transition -> STOP
			event e : diversified?m3
			guard counter >= 5
			transition -> RUN
			event e : diversified?m3
			guard e.a == _a and counter < 5
			action do
				println "#CLI: Ooh, I needed that app?m3(" , e.a , ")!"
				println "#CLI: We meet again, Doctor Jones!"
			end
			transition -> ERROR
			event e : diversified?m3
			guard e.a != _a
			action do
				println "#CLI: Ooh, I needed that app?m3(" , e.a , ")!"
				println "#CLI: Damn, you re ugly."
			end
		}
		final state STOP {
			on entry do
				println "#CLI: What are you waitin for? Christmas?"
				var duration : Integer = `new Date()` - start
				println "#CLI: took " , duration , "ms."
			`process.writeable.end(() => {
					process.exit(0);
				})`
			end
		}
		final state ERROR {
			on entry do
				println "#CLI: Heh, heh, heh... what a mess!"
			`process.exit(1);`
			end
		}
		region generate_m3_from_m3__and_m3a init INIT {
			composite state INIT init S1 {
				property a : Long
				state S1 @diversify "not" {
					transition -> S2
					event ev : app?m3_
					action do
					end
					transition -> S3
					event ev : app?m3a
					action do
						a = ev.a
					end
				}
				state S2 @diversify "not" {
					transition -> S4
					event ev : app?m3a
					action do
						a = ev.a
					end
				}
				state S3 @diversify "not" {
					transition -> S4
					event ev : app?m3_
					action do
					end
				}
				state S4 @diversify "not" {
					on entry do
						diversified!m3(a)
					end
					transition -> S1
				}
			}
		}
	}
}
protocol Default ;

configuration test {
	instance app : App
	instance client1 : Client
	connector client1.app => app . app
}
